<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>Wi-fi controlled car with camera</title>
	<script src="jquery.js"></script>
    <script type="text/javascript">
	
	var frequency = 200;
	var polling = false;

//	var running = false;
	
	var doKeyDown = function(e) {
	var code = e.which;
  if ( code == 13 ) {
   e.preventDefault();
  }
 if (code == 87) {
 	//log("w");
	polling = true;
    poll();
  }
  return true;
	}
	
	var doKeyUp = function(e) {
var code = e.which;
  if (code == 13 ) {
   e.preventDefault();
  }
  if (code == 87) {
  log("u");
    polling = false;
  }
  return true;	
    }	
	
	var poll = function() {
	log("p");
	if (!requesInProgress) {
		doReq();
	}
//	running = true;
};

var requesInProgress = false;

function doReq() {
	var startTime = new Date().getTime();
	requesInProgress = true;
    $.ajax({
        url: "cgi-bin/ser.cgi?cmd=" + "lllll",
        type: "GET",
        dataType: "html",
		cache: false,
		timeout: 1000,
        success: function() {
            log("s");
        },
        complete: function() {
			requesInProgress = false;
			var endTime = new Date().getTime();
			var latency = endTime - startTime;
		    if (polling) {
     			var nextRun = frequency - latency;
	    		if (nextRun > 0) {
					setTimeout(poll, nextRun);
		    	} else {
					poll();
				}
			}
			$("#latency").html(latency);
		},
        error: function() {
            log("e");
        },
    })
}

function log(str) {
	$("#log").append(str);
}

$( document ).ready(function() {
    log( "ready!" );
	
	$("body" ).keydown(doKeyDown);
	$("body" ).keyup(doKeyUp);
	
});

   </script>
</head>
<body>
<table >

    <tr>
        <td>
		<button type="button" >Forward</button><br>
        <button type="button" >Left</button>
        <button type="button" >Right</button><br>
        <button type="button" >Backward</button>
              
        </td>
    </tr>
</table>

latency: <div id="latency"></div>
<br/>

<div id="log">
</div>

</body>
</html>